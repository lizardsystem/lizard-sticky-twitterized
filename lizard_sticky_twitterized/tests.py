# (c) Nelen & Schuurmans.  GPL licensed, see LICENSE.txt.

from django.test import TestCase
from lizard_sticky_twitterized.management import tweet_writer
from lizard_sticky_twitterized.models import StickyTweet

tweet_no_coordinates = {"created_at":"Tue May 28 13:30:17 +0000 2013","id":339373061935603713,"id_str":"339373061935603713","text":"RT @kzchdy: \u597d\u304d\u306b\u7406\u7531\u3063\u3066\u5fc5\u8981\u306a\u306e\uff1f http:\/\/t.co\/pDK3uRw1VC","source":"\u003ca href=\"http:\/\/twitter.com\/download\/android\" rel=\"nofollow\"\u003eTwitter for Android\u003c\/a\u003e","truncated":False,"in_reply_to_status_id":None,"in_reply_to_status_id_str":None,"in_reply_to_user_id":None,"in_reply_to_user_id_str":None,"in_reply_to_screen_name":None,"user":{"id":136203782,"id_str":"136203782","name":"\u82f1\u91cc","screen_name":"nw_eri8","location":"","url":None,"description":"\u4e0b\u4e2d \/ \u7530\u7121 \/ \u5927\u59bb \/ CLINTZ \u2606","protected":False,"followers_count":206,"friends_count":209,"listed_count":0,"created_at":"Fri Apr 23 08:43:49 +0000 2010","favourites_count":187,"utc_offset":32400,"time_zone":"Tokyo","geo_enabled":False,"verified":False,"statuses_count":1846,"lang":"ja","contributors_enabled":False,"is_translator":False,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/a0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/si0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":False,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/3718743408\/8289030808585ddb60f39b75e789fbe7_normal.jpeg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/3718743408\/8289030808585ddb60f39b75e789fbe7_normal.jpeg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/136203782\/1366194380","profile_link_color":"0084B4","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":True,"default_profile":True,"default_profile_image":False,"following":None,"follow_request_sent":None,"notifications":None},"geo":None,"coordinates":None,"place":None,"contributors":None,"retweeted_status":{"created_at":"Tue May 28 12:39:09 +0000 2013","id":339360189583069184,"id_str":"339360189583069184","text":"\u597d\u304d\u306b\u7406\u7531\u3063\u3066\u5fc5\u8981\u306a\u306e\uff1f http:\/\/t.co\/pDK3uRw1VC","source":"\u003ca href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\"\u003eTwitter for iPhone\u003c\/a\u003e","truncated":False,"in_reply_to_status_id":None,"in_reply_to_status_id_str":None,"in_reply_to_user_id":None,"in_reply_to_user_id_str":None,"in_reply_to_screen_name":None,"user":{"id":1276144922,"id_str":"1276144922","name":"\u304b\u305a\u3055\u3061\u3083\u3093","screen_name":"kzchdy","location":"","url":None,"description":"\u776b\u6bdb\u3088\u9577\u304f\u306a\u308c(\u2312\u25bd\u2312)(\u2312\u25bd\u2312)","protected":False,"followers_count":260,"friends_count":309,"listed_count":0,"created_at":"Sun Mar 17 22:16:38 +0000 2013","favourites_count":8,"utc_offset":32400,"time_zone":"Irkutsk","geo_enabled":False,"verified":False,"statuses_count":102,"lang":"ja","contributors_enabled":False,"is_translator":False,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/a0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/si0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":False,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/3621366101\/1b5e4dab40a725bb32fdc7f69925602f_normal.jpeg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/3621366101\/1b5e4dab40a725bb32fdc7f69925602f_normal.jpeg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/1276144922\/1366728893","profile_link_color":"0084B4","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":True,"default_profile":True,"default_profile_image":False,"following":None,"follow_request_sent":None,"notifications":None},"geo":None,"coordinates":None,"place":None,"contributors":None,"retweet_count":1,"favorite_count":0,"entities":{"hashtags":[],"symbols":[],"urls":[],"user_mentions":[],"media":[{"id":339360189587263488,"id_str":"339360189587263488","indices":[13,35],"media_url":"http:\/\/pbs.twimg.com\/media\/BLWmS19CEAA6eYL.jpg","media_url_https":"https:\/\/pbs.twimg.com\/media\/BLWmS19CEAA6eYL.jpg","url":"http:\/\/t.co\/pDK3uRw1VC","display_url":"pic.twitter.com\/pDK3uRw1VC","expanded_url":"http:\/\/twitter.com\/kzchdy\/status\/339360189583069184\/photo\/1","type":"photo","sizes":{"large":{"w":765,"h":1024,"resize":"fit"},"thumb":{"w":150,"h":150,"resize":"crop"},"medium":{"w":600,"h":803,"resize":"fit"},"small":{"w":340,"h":455,"resize":"fit"}}}]},"favorited":False,"retweeted":False,"possibly_sensitive":False,"lang":"ja"},"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"symbols":[],"urls":[],"user_mentions":[{"screen_name":"kzchdy","name":"\u304b\u305a\u3055\u3061\u3083\u3093","id":1276144922,"id_str":"1276144922","indices":[3,10]}],"media":[{"id":339360189587263488,"id_str":"339360189587263488","indices":[25,47],"media_url":"http:\/\/pbs.twimg.com\/media\/BLWmS19CEAA6eYL.jpg","media_url_https":"https:\/\/pbs.twimg.com\/media\/BLWmS19CEAA6eYL.jpg","url":"http:\/\/t.co\/pDK3uRw1VC","display_url":"pic.twitter.com\/pDK3uRw1VC","expanded_url":"http:\/\/twitter.com\/kzchdy\/status\/339360189583069184\/photo\/1","type":"photo","sizes":{"large":{"w":765,"h":1024,"resize":"fit"},"thumb":{"w":150,"h":150,"resize":"crop"},"medium":{"w":600,"h":803,"resize":"fit"},"small":{"w":340,"h":455,"resize":"fit"}},"source_status_id":339360189583069184,"source_status_id_str":"339360189583069184"}]},"favorited":False,"retweeted":False,"possibly_sensitive":False,"filter_level":"low"}
tweet_with_coordinates = {"created_at":"Tue May 28 13:30:18 +0000 2013","id":339373064867442688,"id_str":"339373064867442688","text":"@matutino91 el peaje de la penda desmantelandolo. http:\/\/t.co\/HhoCRjzu56","source":"\u003ca href=\"http:\/\/blackberry.com\/twitter\" rel=\"nofollow\"\u003eTwitter for BlackBerry\u00ae\u003c\/a\u003e","truncated":False,"in_reply_to_status_id":None,"in_reply_to_status_id_str":None,"in_reply_to_user_id":158747597,"in_reply_to_user_id_str":"158747597","in_reply_to_screen_name":"matutino91","user":{"id":189208431,"id_str":"189208431","name":"Cirilo Madera","screen_name":"cirimadera","location":"Santiago de los Caballeros","url":None,"description":None,"protected":False,"followers_count":55,"friends_count":107,"listed_count":0,"created_at":"Fri Sep 10 17:20:20 +0000 2010","favourites_count":2,"utc_offset":-14400,"time_zone":"Atlantic Time (Canada)","geo_enabled":True,"verified":False,"statuses_count":2487,"lang":"es","contributors_enabled":False,"is_translator":False,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/a0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/si0.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":False,"profile_image_url":"http:\/\/a0.twimg.com\/profile_images\/3569297435\/020406da2dad6ab18fdea3e6d90545f1_normal.jpeg","profile_image_url_https":"https:\/\/si0.twimg.com\/profile_images\/3569297435\/020406da2dad6ab18fdea3e6d90545f1_normal.jpeg","profile_link_color":"0084B4","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":True,"default_profile":True,"default_profile_image":False,"following":None,"follow_request_sent":None,"notifications":None},"geo":{"type":"Point","coordinates":[18.5339,-70.01739]},"coordinates":{"type":"Point","coordinates":[-70.01739,18.5339]},"place":None,"contributors":None,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"symbols":[],"urls":[],"user_mentions":[{"screen_name":"matutino91","name":"Matutino Teo Veras","id":158747597,"id_str":"158747597","indices":[0,11]}],"media":[{"id":339373064871636992,"id_str":"339373064871636992","indices":[50,72],"media_url":"http:\/\/pbs.twimg.com\/media\/BLWyASICcAASoBU.jpg","media_url_https":"https:\/\/pbs.twimg.com\/media\/BLWyASICcAASoBU.jpg","url":"http:\/\/t.co\/HhoCRjzu56","display_url":"pic.twitter.com\/HhoCRjzu56","expanded_url":"http:\/\/twitter.com\/cirimadera\/status\/339373064867442688\/photo\/1","type":"photo","sizes":{"medium":{"w":600,"h":337,"resize":"fit"},"small":{"w":340,"h":191,"resize":"fit"},"thumb":{"w":150,"h":150,"resize":"crop"},"large":{"w":640,"h":359,"resize":"fit"}}}]},"favorited":False,"retweeted":False,"possibly_sensitive":False,"filter_level":"low","lang":"es"}


class HarvestTest(TestCase):

    def test_writer_class(self):
        writer = tweet_writer.TweetWriter(tweet_no_coordinates)
        self.assertEqual(writer.tweet.get("id"), 339373061935603713)

    def test_store_no_coordinates(self):
        writer = tweet_writer.TweetWriter(tweet_no_coordinates)
        writer.store()
        self.assertEqual(StickyTweet.objects.all().count(), 0)

    def test_store_with_coordinates(self):
        writer = tweet_writer.TweetWriter(tweet_with_coordinates)
        writer.store()
        self.assertEqual(StickyTweet.objects.all().count(), 1)

    def test_overwrite_with_more_than_300(self):
        writer = tweet_writer.TweetWriter(tweet_with_coordinates)
        for i in range(310):
            writer.store()
        self.assertEqual(StickyTweet.objects.all().count(), 300)
